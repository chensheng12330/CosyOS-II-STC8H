# RTOS / CosyOS-II for STC MCU 的实时系统  
  
## 简介  
  
CosyOS是一款来自中国的开源实时操作系统，专为满足对系统实时性及中断响应速度有较高要求的场合而设计。从经典的8051内核到流行的Arm Cortex-M内核，CosyOS均能实现全局不关总中断、零中断延迟。此外，CosyOS的任务切换效率无与伦比，易用性也超乎想象，更拥有多项安全关键技术，助力用户打造更加实时安全的嵌入式产品。  
  
### 支持内核  
  
CosyOS现原生支持以下内核：  
- 8051/STC8H  
- STC32位8051/STC32G12K128  
- Cortex-M  
  
并且已经过STC8H和STC32的实际开发测试，可以说是为STC8051世界量身定做，无需移植。未来，CosyOS将陆续添加对其它内核的支持。  
  
### 编译环境  
  
CosyOS是在以下编译器下开发的，对其支持最好：  
- Keil C51  
- Keil C251  
- MDK-Arm  
  
未来，CosyOS将陆续优化调整对其它编译器的支持。  
  
## 突破创新  
  
CosyOS具有多项突破创新功能：  
  
- **全局不关总中断、零中断延迟**：从系统层面保证了用户中断的实时响应。  
- **独家技术实现系统服务函数的可重入**：使51彻底摆脱可重入栈、全面提速。  
- **针对51做了高度的性能优化**：使51焕发新生。  
- **251支持MSP、PSP两种栈模式**：其中PSP模式可使任务的切换效率等同于Cortex-M。  
- **定时服务（软件定时器中断）**：支持钩子和任务，任务优先级可由用户灵活配置。  
- **独创的飞信**：极简类型、极速通信，是线程间通信的利器。  
- **独创的私信**：随意定义，灵活多变，便于多条消息的传递。  
- **消息邮箱**：任意类型，指针引用。  
- **消息队列**：支持静态队列和动态队列，传输模式支持FIFO、LIFO，采用高效的指针引用方式。  
- **事件标志组**：声明标志组的同时定义标志位，不同标志组的标志位可以重名，通过组名和位名访问，极大地方便了标志组的应用。  
- **全局变量访问**：支持在任意任务和中断中对全局变量的安全访问，而不必担心重入的发生。  
- **软件RTC**：支持设置时间和获取时间，可替代硬件RTC。  
- **安全关键技术**：拥有多项安全关键技术，如中断挂起服务空间隔离、安全运行时等，可靠性高。  
- **任务栈监控**：拥有多项任务栈监控措施，可提前预判任务栈溢出的风险。  
  
### 什么是零中断延迟？  
  
零中断延迟并非是中断响应时间为零，而是指当引入了RTOS以后，中断响应时间仍然能够达到MCU内核特性的响应时间。即只要中断发生，就能按中断优先级立即抢占，不存在指令级延误。也就是说，中断响应时间不受RTOS影响，与裸机编程是一样的。  
  
## CosyOS - 实时运行模型

# CosyOS 实时运行模型与零中断延迟基本原理  
  
## CosyOS 实时运行模型  
  
### 中断层  
  
- **用户中断**（按中断优先级实时抢占，实现零中断延迟）：  
  - 中断本地服务的执行  
  - 中断挂起服务的装载  
  
### 服务层  
  
- **内核服务**：  
  - **SysTick**（最低优先级 [minpri]）：  
    - 软件RTC/定时器计数  
    - 恢复定时任务  
    - 调用定时钩子/滴答钩子（执行滴答服务）  
  - **PendSV**（最低优先级 [minpri]）：  
    - 中断挂起服务的执行  
    - 任务调度/切换  
  - **任务临界区**（关闭SysTick/PendSV）：  
    - 执行任务服务  
  
### 任务层  
  
- **抢占式调度**（不同优先级的任务）  
- **时间片轮转调度**（相同优先级的任务）  
- **任务优先级**：  
  - Taskmgr（最高优先级 [maxpri]）  
  - Debugger（最高优先级 [maxpri]）  
  - Starter（次高优先级 [maxpri-1]）  
  - 一般用户任务（[maxpri-1] ~ [minpri+1]）  
  - 用户空闲任务（最低优先级 [minpri:0]）  
  - 系统空闲任务（最低优先级 [minpri:0]）  
  
## CosyOS 零中断延迟基本原理  
  
1. **服务层互斥访问**：  
   - SysTick、PendSV、任务临界区三者间互斥访问，整个服务层视为一个大临界区（服务层临界区）。  
  
2. **内核服务执行保障**：  
   - 所有内核服务（中断本地服务除外）均在服务层临界区内执行，确保服务操作流不被打断。  
  
3. **中断本地服务互斥机制**：  
   - 中断本地服务采用互斥访问机制，确保中断处理的实时性和完整性。

##### 来源: https://www.stcaimcu.com/forum.php?mod=viewthread&tid=1807
